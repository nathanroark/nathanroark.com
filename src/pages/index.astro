---
import Layout from "@/layouts/layout.astro";
import HomeSection from "@/components/home-section.astro";
import { getCollection } from "astro:content";

const ITEMS_PER_SECTION = 14;
const currentYear = new Date().getFullYear();

// Helper functions
const sortByDate = (a: any, b: any, dateField: string) => 
  new Date(a.data[dateField]) > new Date(b.data[dateField]) ? -1 : 1;

const sortByScore = (a: any, b: any) => (b.data.score ?? 0) - (a.data.score ?? 0);

const getAlbumsByYear = (albums: any[], year: number) =>
  albums.filter((album) => new Date(album.data.release_date).getFullYear() === year);

// Music: Show current year albums by score, fill with best of last year if needed
const allAlbums = (await getCollection("music")).sort((a, b) => sortByDate(a, b, "release_date"));
const thisYearAlbums = getAlbumsByYear(allAlbums, currentYear).sort(sortByScore);

const musicPosts = thisYearAlbums.length >= ITEMS_PER_SECTION
  ? thisYearAlbums.slice(0, ITEMS_PER_SECTION)
  : [
      ...thisYearAlbums,
      ...getAlbumsByYear(allAlbums, currentYear - 1)
        .sort(sortByScore)
        .slice(0, ITEMS_PER_SECTION - thisYearAlbums.length),
    ];

// Movies: Top rated
const moviePosts = (await getCollection("movies"))
  .sort(sortByScore)
  .slice(0, ITEMS_PER_SECTION);

// Anime: Most recent
const animePosts = (await getCollection("anime"))
  .sort((a, b) => {
    const getDate = (x: any) => x.data.releaseDate ?? x.data.startDate;
    const ad = getDate(a), bd = getDate(b);
    if (!ad && !bd) return 0;
    if (!ad) return 1;
    if (!bd) return -1;
    return ad > bd ? -1 : 1;
  })
  .slice(0, ITEMS_PER_SECTION);

// Books: Most recently read
const bookPosts = (await getCollection("books"))
  .sort((a, b) => sortByDate(a, b, "read"))
  .slice(0, ITEMS_PER_SECTION);
---

<Layout
  title="Nathan's Blog"
  description="A blog about music, movies, anime, and books"
>
  <div class="mx-auto flex w-full flex-col space-y-16 pt-4">
    <div>
      <h1 class="text-5xl font-bold">Nathan's Blog</h1>
      <p class="text-xl">
        A blog for me to post about music, movies, anime, and books
      </p>
    </div>

    <HomeSection title="Music" href="music/" posts={musicPosts} type="music" />
    <HomeSection title="Movie" href="movies/" posts={moviePosts} type="movies" />
    <HomeSection title="Anime" href="anime/" posts={animePosts} type="anime" />
    <HomeSection title="Book" href="books/" posts={bookPosts} type="books" />
  </div>
</Layout>
